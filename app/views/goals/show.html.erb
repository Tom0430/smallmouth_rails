<body>
<%= @goal.title %>
<%= @goal.detail %>

<p id ="timer-text">あと<span id = "timer"></span>でチャレンジ終了！</p>
<% if @goal.status == "trying" %>
    <div><%= link_to "達成できた", achieved_user_goal_path(@goal.user.id,@goal.id) %></div>
    <div class="failed-text"><%= link_to "達成できなかった", failed_user_goal_path(@goal.user.id,@goal.id) %></div>
<% end %>

<%if @goal.user.id == current_user.id %>
    <p>チャレンジの記録を残そう！!</p>
    <%= form_for [@user, @goal, @progress] do |f| %>
        <%= f.text_area :body, rows:'5', class: "form-control",placeholder: "チャレンジの過程をここに" %>
        <%= f.submit "送信する", class: "btn btn-lg btn-base-1 mt-20 pull-right" %>
    <% end %>
<% end %>

<hr>
<% @goal.progresses.each do |progress| %>
    <p><%= progress.goal.user.name %>さん</p>
    <%= progress.body %>
    <hr>
<% end %>

<% @goal.comments.each do |comment| %>
    <%= comment.user.name %>
    <%= comment.body %>
    <hr>
<% end %>

<%= form_for [@user, @goal, @comment] do |f| %>
    <%= f.text_area :body, rows:'5', class: "form-control",placeholder: "コメントをここに" %>
    <%= f.submit "送信する", class: "btn btn-lg btn-base-1 mt-20 pull-right" %>
<% end %>

<%= link_to"新規目標", new_user_goal_path %>


</body>


<script>
    // カウントダウンタイマー
    var limit = new Date("<%= @goal.remaining_time %>");
    var countdown = function(limit_due) {
        var now = new Date();
        // modelの値(不変) - 今の時刻(どんどん増えてく。ブラウザの更新によらない)
        var rest = limit_due.getTime() - now.getTime();
        var sec = Math.floor(rest / 1000 % 60);
        var min = Math.floor(rest / 1000 / 60) % 60;
        var hours = Math.floor(rest / 1000 / 60 / 60) % 24;
        var days = Math.floor(rest/ 1000 / 60 / 60 / 24 )
        var count_hash = {days: days, hours: hours, min: min, sec: sec}

        return count_hash;
    }

    //var failed_text = document.getElementsById("aaa");
    var failed_text = document.getElementsByClassName("failed-text");
    var recale = function() {
        var counter = countdown(limit);
        if(counter["days"] <= 0 && counter["hours"] <= 0 && counter["min"] <= 0 && counter["sec"] <= 0){
            document.getElementById('timer-text').textContent = "チャレンジ終了！達成できましたか？";
            failed_text[0].style.display = "block";
            return
        }
        else{
            one_second_recale_refresh();
        }
        var time = counter["days"] + '日' + counter["hours"] + '時間' + counter["min"] + '分' + counter["sec"] + '秒';
        document.getElementById('timer').textContent = time;
    }

    var one_second_recale_refresh = function() {
        setTimeout(recale, 1000)
    }

    recale();

</script>